@model CalifornianHealthApp.Models.DTOs.ConsultantModelList

@{
    ViewBag.Title = "Home Page";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<section id="form-appointment" class="section-padding">
    <div class="container">
        <div class="row">
            <div class="col-md-5">
                <form>
                    <div class="text-danger" id="validationText"></div>
                    <div class="form-group">
                        <label for="consultant">Select Consultant you wish to make an appointment for</label>
                        @Html.DropDownListFor(m => m.SelectedConsultantId, Model.ConsultantsList, "- Please select -", new { @id = "consultantSelect" , @class = "form-control"})
                    </div>
                    <div class="form-group">
                        <label class="control-label">Date</label>
                        <select id="dateSelect" class="form-control"></select>
                    </div>
                    <div class="form-group">
                        <label class="control-label">Hour</label>
                        <select id="appointmentSelect" class="form-control"></select>
                    </div>
                </form>
                <input id="submit-appointment" class="btn btn-primary" />
            </div>
        </div>
    </div>
</section>
<section>
    <script>
        var dates = @Html.Raw(Json.Serialize(Model.consultantCalendar));

        $(document).ready(function () {
            var selectedConsultant;
            $("#consultantSelect").change(function () {
                selectedConsultant = $(this).val();
                console.log(dates);
                var optionsForSelected = dates.find(item => item.consultant.id == selectedConsultant);
                
                $('#dateSelect, #appointmentSelect').empty();
                 $('#dateSelect').append($('<option>', {
                    text: " - Please select -"
                }));
                $.each(optionsForSelected.dates, function (index, value) {
                    $('#dateSelect').append($('<option>', {
                        value: value,
                        text: new Date(value).toLocaleDateString()
                    }));
                });
            });
            $("#dateSelect").change(function () {
                var selectedOption = $(this).val();
                $.ajax({
                    url: '/Booking/ConsultantAppointments',
                    type: 'POST',
                    data: { 
                        ConsultantId: selectedConsultant,
                        Day: selectedOption
                    },
                    success: function (res) {
                        var data = JSON.parse(res);
                        $('#appointmentSelect').empty();
                        data.forEach(function (value) {
                            var option = document.createElement("option");
                            option.value = value.id;
                            option.text = new Date(value.startDateTime).toLocaleTimeString();
                            document.getElementById("appointmentSelect").appendChild(option);
                        });
                    }
                });
            })

        });
    </script>
</section>